# Processor Service - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–°—Ç–∞—Ç—É—Å**: Not Started
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 5-7 –¥–Ω–µ–π
**–ë–ª–æ–∫–∏—Ä—É–µ—Ç**: MVP –ø—Ä–æ–µ–∫—Ç–∞

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Processor Service - –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–ø–∏—Å–∏ AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (title, description, keywords) –≤ —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ü–µ–ø–æ—á–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ Photo Tags.

### –ú–µ—Å—Ç–æ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Gateway   ‚îÇ ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ   Analyzer   ‚îÇ ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ  Processor  ‚îÇ ‚îÄ‚îÄ‚îÄ‚ñ∫ Gateway
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚ñ≤                                            ‚îÇ
      ‚îÇ                                            ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `metadata_generated` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –æ—Ç Analyzer Service
**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –≤ MinIO + —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å `image_processed`

---

## üéØ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ RabbitMQ

**Consumer –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ `metadata_generated`:**
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–∏–ø–∞ `MetadataGenerated` (—Å–º. `pkg/models/messages.go:17-25`)
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: trace_id, original_path, metadata (title, description, keywords)
- Parallel worker pool –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### 2. –†–∞–±–æ—Ç–∞ —Å MinIO

**–û–ø–µ—Ä–∞—Ü–∏–∏ —Å object storage:**
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ bucket `original` –ø–æ –ø—É—Ç–∏ `original_path`
- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ bucket `processed`
- –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ: `processed/{trace_id}/{original_filename}`
- Timeout –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π: 30 —Å–µ–∫—É–Ω–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π)
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö

### 3. –ó–∞–ø–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ExifTool:**

ExifTool - –≤–Ω–µ—à–Ω—è—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ:

```go
// –ü—Å–µ–≤–¥–æ–∫–æ–¥ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
type ExifToolWrapper interface {
    WriteMetadata(imagePath string, metadata Metadata) error
}

// –ó–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ–≥–∏:
// - EXIF: ImageDescription, XPTitle, XPKeywords
// - IPTC: Caption-Abstract, Headline, Keywords
// - XMP: dc:title, dc:description, dc:subject
```

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏:**
- **Title** ‚Üí EXIF:XPTitle, IPTC:Headline, XMP:dc:title
- **Description** ‚Üí EXIF:ImageDescription, IPTC:Caption-Abstract, XMP:dc:description
- **Keywords** ‚Üí EXIF:XPKeywords, IPTC:Keywords, XMP:dc:subject (–º–∞—Å—Å–∏–≤)

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:** JPG, JPEG, PNG

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ù–µ –∏–∑–º–µ–Ω—è—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Unicode (—Ä—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å

### 4. –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**Publisher –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ `image_processed`:**

–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ `ImageProcessed` (—Å–º. `pkg/models/messages.go:40-50`):

```json
{
  "trace_id": "uuid",
  "group_id": "uuid",
  "telegram_id": 123456789,
  "telegram_username": "username",
  "original_filename": "image.jpg",
  "processed_path": "processed/uuid/image.jpg",
  "status": "completed",
  "error": "",
  "timestamp": "2025-11-18T12:00:00Z"
}
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `completed` - —É—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- `failed` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤ –ø–æ–ª–µ `error`)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

–°–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Analyzer Service:

```
services/processor/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ main.go                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.go                   # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, worker pool
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.go                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config_test.go
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message.go           # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ interfaces.go        # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è DI
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ processor.go         # –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ processor_test.go
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ message_processor.go # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ RabbitMQ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ exiftool/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.go                # Wrapper –¥–ª—è ExifTool
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client_test.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mock.go                  # Mock –¥–ª—è —Ç–µ—Å—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ minio/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ client.go            # MinIO –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ client_test.go
‚îÇ   ‚îî‚îÄ‚îÄ transport/
‚îÇ       ‚îî‚îÄ‚îÄ rabbitmq/
‚îÇ           ‚îú‚îÄ‚îÄ consumer.go          # RabbitMQ consumer
‚îÇ           ‚îú‚îÄ‚îÄ publisher.go         # RabbitMQ publisher
‚îÇ           ‚îú‚îÄ‚îÄ consumer_test.go
‚îÇ           ‚îî‚îÄ‚îÄ publisher_test.go
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ go.sum
‚îî‚îÄ‚îÄ Dockerfile
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. Config (`internal/config/config.go`)

```go
type Config struct {
    Log struct {
        Level  string
        Format string
    }

    RabbitMQ struct {
        URL               string
        ConsumerQueue     string  // "metadata_generated"
        PublisherQueue    string  // "image_processed"
        ReconnectDelay    time.Duration
        ReconnectAttempts int
        PrefetchCount     int
    }

    MinIO struct {
        Endpoint         string
        AccessKey        string
        SecretKey        string
        OriginalBucket   string  // "original"
        ProcessedBucket  string  // "processed"
        DownloadTimeout  time.Duration
        UploadTimeout    time.Duration
        ConnectAttempts  int
        ConnectDelay     time.Duration
        UseSSL           bool
    }

    ExifTool struct {
        BinaryPath      string  // –ü—É—Ç—å –∫ exiftool binary
        TempDir         string  // –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        CommandTimeout  time.Duration
    }

    Worker struct {
        Concurrency int           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤
        MaxRetries  int           // –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        RetryDelay  time.Duration // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
    }
}
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
# RabbitMQ
RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
RABBITMQ_CONSUMER_QUEUE=metadata_generated
RABBITMQ_PUBLISHER_QUEUE=image_processed
RABBITMQ_PREFETCH_COUNT=1
RABBITMQ_RECONNECT_ATTEMPTS=5
RABBITMQ_RECONNECT_DELAY=5s

# MinIO
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_USE_SSL=false
MINIO_ORIGINAL_BUCKET=original
MINIO_PROCESSED_BUCKET=processed
MINIO_DOWNLOAD_TIMEOUT=30s
MINIO_UPLOAD_TIMEOUT=30s
MINIO_CONNECT_ATTEMPTS=5
MINIO_CONNECT_DELAY=3s

# ExifTool
EXIFTOOL_BINARY_PATH=/usr/bin/exiftool
EXIFTOOL_TEMP_DIR=/tmp/processor
EXIFTOOL_COMMAND_TIMEOUT=10s

# Worker
WORKER_CONCURRENCY=3
WORKER_MAX_RETRIES=3
WORKER_RETRY_DELAY=5s

# Logging
LOG_LEVEL=info
LOG_FORMAT=json
```

#### 2. ExifTool Client (`internal/exiftool/client.go`)

```go
package exiftool

import (
    "context"
    "fmt"
    "os/exec"
    "strings"
)

type Client struct {
    binaryPath string
    timeout    time.Duration
    logger     *logrus.Logger
}

type Metadata struct {
    Title       string
    Description string
    Keywords    []string
}

func NewClient(binaryPath string, timeout time.Duration, logger *logrus.Logger) *Client {
    return &Client{
        binaryPath: binaryPath,
        timeout:    timeout,
        logger:     logger,
    }
}

// WriteMetadata –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
func (c *Client) WriteMetadata(ctx context.Context, imagePath string, metadata Metadata, traceID string) error {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è exiftool
    if _, err := exec.LookPath(c.binaryPath); err != nil {
        return fmt.Errorf("exiftool not found: %w", err)
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    ctx, cancel := context.WithTimeout(ctx, c.timeout)
    defer cancel()

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è exiftool
    args := []string{
        "-overwrite_original",     // –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
        "-charset", "utf8",        // UTF-8 –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

        // EXIF —Ç–µ–≥–∏
        fmt.Sprintf("-XPTitle=%s", metadata.Title),
        fmt.Sprintf("-ImageDescription=%s", metadata.Description),

        // IPTC —Ç–µ–≥–∏
        fmt.Sprintf("-IPTC:Headline=%s", metadata.Title),
        fmt.Sprintf("-IPTC:Caption-Abstract=%s", metadata.Description),

        // XMP —Ç–µ–≥–∏
        fmt.Sprintf("-XMP:Title=%s", metadata.Title),
        fmt.Sprintf("-XMP:Description=%s", metadata.Description),

        imagePath,
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ keywords
    for _, keyword := range metadata.Keywords {
        args = append(args, fmt.Sprintf("-IPTC:Keywords=%s", keyword))
        args = append(args, fmt.Sprintf("-XMP:Subject=%s", keyword))
    }

    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    cmd := exec.CommandContext(ctx, c.binaryPath, args...)

    output, err := cmd.CombinedOutput()
    if err != nil {
        c.logger.WithFields(logrus.Fields{
            "trace_id": traceID,
            "output":   string(output),
            "error":    err.Error(),
        }).Error("ExifTool command failed")
        return fmt.Errorf("exiftool failed: %w, output: %s", err, string(output))
    }

    c.logger.WithFields(logrus.Fields{
        "trace_id": traceID,
        "output":   string(output),
    }).Debug("ExifTool command succeeded")

    return nil
}

// VerifyMetadata –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
func (c *Client) VerifyMetadata(ctx context.Context, imagePath string, traceID string) (bool, error) {
    ctx, cancel := context.WithTimeout(ctx, c.timeout)
    defer cancel()

    // –ß–∏—Ç–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
    cmd := exec.CommandContext(ctx, c.binaryPath, "-j", "-Title", "-Description", "-Keywords", imagePath)
    output, err := cmd.CombinedOutput()
    if err != nil {
        return false, fmt.Errorf("verification failed: %w", err)
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ output –Ω–µ –ø—É—Å—Ç–æ–π
    return len(output) > 0 && !strings.Contains(string(output), "error"), nil
}
```

**–¢–µ—Å—Ç—ã:**
- Unit —Ç–µ—Å—Ç—ã —Å mock exec.Command
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ Unicode
- –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

#### 3. Image Processor Service (`internal/domain/service/processor.go`)

```go
package service

import (
    "context"
    "fmt"
    "os"
    "path/filepath"
)

type ImageProcessorService struct {
    minioClient  MinioClientInterface
    exifTool     ExifToolInterface
    logger       *logrus.Logger
    tempDir      string
}

func NewImageProcessor(
    minioClient MinioClientInterface,
    exifTool ExifToolInterface,
    tempDir string,
    logger *logrus.Logger,
) *ImageProcessorService {
    return &ImageProcessorService{
        minioClient: minioClient,
        exifTool:    exifTool,
        tempDir:     tempDir,
        logger:      logger,
    }
}

// ProcessImage –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: —Å–∫–∞—á–∏–≤–∞–µ—Ç, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –∑–∞–≥—Ä—É–∂–∞–µ—Ç
func (s *ImageProcessorService) ProcessImage(
    ctx context.Context,
    originalPath string,
    processedPath string,
    metadata model.Metadata,
    traceID string,
) error {
    s.logger.WithFields(logrus.Fields{
        "trace_id":       traceID,
        "original_path":  originalPath,
        "processed_path": processedPath,
    }).Info("Starting image processing")

    // 1. –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ MinIO (bucket: original)
    imageBytes, err := s.minioClient.DownloadImage(ctx, originalPath)
    if err != nil {
        s.logger.WithFields(logrus.Fields{
            "trace_id": traceID,
            "error":    err.Error(),
        }).Error("Failed to download image from MinIO")
        return fmt.Errorf("download failed: %w", err)
    }

    s.logger.WithFields(logrus.Fields{
        "trace_id":      traceID,
        "image_size_kb": len(imageBytes) / 1024,
    }).Debug("Image downloaded successfully")

    // 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    tempFilePath := filepath.Join(s.tempDir, fmt.Sprintf("%s_temp.jpg", traceID))
    if err := os.WriteFile(tempFilePath, imageBytes, 0644); err != nil {
        return fmt.Errorf("failed to write temp file: %w", err)
    }
    defer os.Remove(tempFilePath) // Cleanup

    // 3. –ó–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é ExifTool
    if err := s.exifTool.WriteMetadata(ctx, tempFilePath, metadata, traceID); err != nil {
        s.logger.WithFields(logrus.Fields{
            "trace_id": traceID,
            "error":    err.Error(),
        }).Error("Failed to write metadata")
        return fmt.Errorf("metadata write failed: %w", err)
    }

    s.logger.WithFields(logrus.Fields{
        "trace_id": traceID,
        "title":    metadata.Title,
        "keywords": len(metadata.Keywords),
    }).Info("Metadata written successfully")

    // 4. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å
    verified, err := s.exifTool.VerifyMetadata(ctx, tempFilePath, traceID)
    if err != nil || !verified {
        s.logger.WithFields(logrus.Fields{
            "trace_id": traceID,
            "verified": verified,
        }).Warn("Metadata verification failed")
    }

    // 5. –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ MinIO (bucket: processed)
    processedImageBytes, err := os.ReadFile(tempFilePath)
    if err != nil {
        return fmt.Errorf("failed to read processed file: %w", err)
    }

    if err := s.minioClient.UploadImage(ctx, processedPath, processedImageBytes); err != nil {
        s.logger.WithFields(logrus.Fields{
            "trace_id": traceID,
            "error":    err.Error(),
        }).Error("Failed to upload processed image to MinIO")
        return fmt.Errorf("upload failed: %w", err)
    }

    s.logger.WithFields(logrus.Fields{
        "trace_id":       traceID,
        "processed_path": processedPath,
    }).Info("Image processing completed successfully")

    return nil
}
```

#### 4. Message Processor (`internal/domain/service/message_processor.go`)

```go
package service

import (
    "context"
    "encoding/json"
    "fmt"
    "time"

    "github.com/shabohin/photo-tags/pkg/models"
)

type MessageProcessorService struct {
    imageProcessor ImageProcessorInterface
    publisher      PublisherInterface
    logger         *logrus.Logger
    maxRetries     int
    retryDelay     time.Duration
}

func NewMessageProcessor(
    imageProcessor ImageProcessorInterface,
    publisher PublisherInterface,
    logger *logrus.Logger,
    maxRetries int,
    retryDelay time.Duration,
) *MessageProcessorService {
    return &MessageProcessorService{
        imageProcessor: imageProcessor,
        publisher:      publisher,
        logger:         logger,
        maxRetries:     maxRetries,
        retryDelay:     retryDelay,
    }
}

// Process –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ RabbitMQ
func (s *MessageProcessorService) Process(ctx context.Context, messageBody []byte) error {
    // –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è
    var msg models.MetadataGenerated
    if err := json.Unmarshal(messageBody, &msg); err != nil {
        s.logger.WithError(err).Error("Failed to unmarshal message")
        return fmt.Errorf("unmarshal failed: %w", err)
    }

    s.logger.WithFields(logrus.Fields{
        "trace_id":   msg.TraceID,
        "group_id":   msg.GroupID,
        "telegram_id": msg.TelegramID,
    }).Info("Processing metadata_generated message")

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ processed_path
    processedPath := fmt.Sprintf("processed/%s/%s", msg.TraceID, msg.OriginalFilename)

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å retry –ª–æ–≥–∏–∫–æ–π
    var lastErr error
    for attempt := 0; attempt < s.maxRetries; attempt++ {
        if attempt > 0 {
            s.logger.WithFields(logrus.Fields{
                "trace_id": msg.TraceID,
                "attempt":  attempt,
            }).Info("Retrying image processing")
            time.Sleep(s.retryDelay)
        }

        err := s.imageProcessor.ProcessImage(
            ctx,
            msg.OriginalPath,
            processedPath,
            msg.Metadata,
            msg.TraceID,
        )

        if err == nil {
            // –£—Å–ø–µ—Ö - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å completed message
            return s.publishResult(ctx, msg, processedPath, "completed", "")
        }

        lastErr = err
        s.logger.WithFields(logrus.Fields{
            "trace_id": msg.TraceID,
            "attempt":  attempt,
            "error":    err.Error(),
        }).Warn("Image processing attempt failed")
    }

    // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å failed message
    s.logger.WithFields(logrus.Fields{
        "trace_id": msg.TraceID,
        "error":    lastErr.Error(),
    }).Error("Image processing failed after all retries")

    return s.publishResult(ctx, msg, "", "failed", lastErr.Error())
}

// publishResult –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ—á–µ—Ä–µ–¥—å image_processed
func (s *MessageProcessorService) publishResult(
    ctx context.Context,
    originalMsg models.MetadataGenerated,
    processedPath string,
    status string,
    errorMsg string,
) error {
    result := models.ImageProcessed{
        TraceID:          originalMsg.TraceID,
        GroupID:          originalMsg.GroupID,
        TelegramID:       originalMsg.TelegramID,
        TelegramUsername: "", // Will be filled by Gateway
        OriginalFilename: originalMsg.OriginalFilename,
        ProcessedPath:    processedPath,
        Status:           status,
        Error:            errorMsg,
        Timestamp:        time.Now(),
    }

    resultBytes, err := json.Marshal(result)
    if err != nil {
        return fmt.Errorf("failed to marshal result: %w", err)
    }

    if err := s.publisher.Publish(ctx, resultBytes); err != nil {
        s.logger.WithFields(logrus.Fields{
            "trace_id": originalMsg.TraceID,
            "error":    err.Error(),
        }).Error("Failed to publish result")
        return fmt.Errorf("publish failed: %w", err)
    }

    s.logger.WithFields(logrus.Fields{
        "trace_id": originalMsg.TraceID,
        "status":   status,
    }).Info("Result published successfully")

    return nil
}
```

#### 5. App Initialization (`internal/app/app.go`)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Analyzer Service (—Å–º. –≤—ã—à–µ), –Ω–æ —Å Processor-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:
- MinioClient –¥–ª—è `original` –∏ `processed` buckets
- ExifTool client
- ImageProcessor service
- MessageProcessor service
- RabbitMQ Consumer/Publisher
- Worker pool

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**

1. **ExifTool Client** (`exiftool/client_test.go`):
   - –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   - –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ Unicode
   - –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ exec
   - –¢–µ—Å—Ç timeout
   - Mock –¥–ª—è exec.Command

2. **Image Processor** (`domain/service/processor_test.go`):
   - –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –¢–µ—Å—Ç –æ—à–∏–±–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
   - –¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   - –¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
   - Mock –¥–ª—è MinIO –∏ ExifTool

3. **Message Processor** (`domain/service/message_processor_test.go`):
   - –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –¢–µ—Å—Ç retry –ª–æ–≥–∏–∫–∏
   - –¢–µ—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ completed message
   - –¢–µ—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ failed message
   - Mock –¥–ª—è –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

4. **RabbitMQ Transport** (`transport/rabbitmq/*_test.go`):
   - –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –¢–µ—Å—Ç reconnect –ª–æ–≥–∏–∫–∏
   - –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - Mock –¥–ª—è RabbitMQ

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```go
// integration_test.go
func TestProcessorIntegration(t *testing.T) {
    // Setup: MinIO, RabbitMQ, ExifTool
    // 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ MinIO (original bucket)
    // 2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å MetadataGenerated message –≤ RabbitMQ
    // 3. –î–æ–∂–¥–∞—Ç—å—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    // 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ processed bucket
    // 5. –°–∫–∞—á–∞—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ ExifTool
    // 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ImageProcessed message –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
}
```

**–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ù–∞–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: JPG (—Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤), PNG
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å Unicode (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏
- –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ keywords (49 —à—Ç—É–∫)

### E2E —Ç–µ—Å—Ç (–ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Gateway –∏ Analyzer)

–ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É:
1. Gateway –ø–æ–ª—É—á–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ image_upload
2. Analyzer –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ metadata_generated
3. **Processor –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ image_processed**
4. Gateway –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## üê≥ Docker –∏ –¥–µ–ø–ª–æ–π

### Dockerfile

```dockerfile
FROM golang:1.24-alpine AS builder

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–±–æ—Ä–∫–∏
RUN apk add --no-cache git

WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ go.mod –∏ go.sum
COPY go.mod go.sum ./
RUN go mod download

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY . .

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
RUN CGO_ENABLED=0 GOOS=linux go build -o processor ./cmd/main.go

# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
FROM alpine:latest

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ExifTool –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apk add --no-cache \
    exiftool \
    perl \
    ca-certificates \
    tzdata

WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
COPY --from=builder /app/processor .

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
RUN mkdir -p /tmp/processor && chmod 777 /tmp/processor

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
CMD ["./processor"]
```

### Docker Compose –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `docker/docker-compose.yml`:

```yaml
processor:
  build:
    context: ../services/processor
    dockerfile: Dockerfile
  container_name: processor
  environment:
    - RABBITMQ_URL=amqp://user:password@rabbitmq:5672/
    - RABBITMQ_CONSUMER_QUEUE=metadata_generated
    - RABBITMQ_PUBLISHER_QUEUE=image_processed
    - MINIO_ENDPOINT=minio:9000
    - MINIO_ACCESS_KEY=minioadmin
    - MINIO_SECRET_KEY=minioadmin
    - MINIO_ORIGINAL_BUCKET=original
    - MINIO_PROCESSED_BUCKET=processed
    - EXIFTOOL_BINARY_PATH=/usr/bin/exiftool
    - EXIFTOOL_TEMP_DIR=/tmp/processor
    - WORKER_CONCURRENCY=3
    - LOG_LEVEL=info
    - LOG_FORMAT=json
  depends_on:
    - rabbitmq
    - minio
  networks:
    - photo-tags
  restart: unless-stopped
  volumes:
    - processor-temp:/tmp/processor

volumes:
  processor-temp:
```

---

## üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

1. **Transient errors** (retry):
   - Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MinIO
   - Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ RabbitMQ
   - –í—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ExifTool
   - **–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: Retry —Å exponential backoff

2. **Permanent errors** (fail fast):
   - –ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (JSON parse error)
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ MinIO
   - –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - ExifTool –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
   - **–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å failed message

3. **Partial failures**:
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã, –Ω–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è failed
   - **–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: –°—á–∏—Ç–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–º, –Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å warning

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å:
- `trace_id` - –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
- `worker_id` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–æ—Ä–∫–µ—Ä–∞
- Timestamp
- Error details
- Context (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–µ–ª–∞–ª–æ—Å—å)

**–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–æ–≤:**
- DEBUG: –î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
- INFO: –ù–∞—á–∞–ª–æ/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏, —É—Å–ø–µ—Ö–∏
- WARN: Retry –ø–æ–ø—ã—Ç–∫–∏, —á–∞—Å—Ç–∏—á–Ω—ã–µ failures
- ERROR: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, failed processing

---

## ‚úÖ Acceptance Criteria

**Processor Service —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º –∫–æ–≥–¥–∞:**

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- [ ] Consumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `metadata_generated`
- [ ] –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏–∑ MinIO bucket `original`
- [ ] –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (title, description, keywords) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ EXIF/IPTC/XMP
- [ ] –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ MinIO bucket `processed`
- [ ] Publisher –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å `image_processed` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `completed` –∏–ª–∏ `failed`
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, JPEG, PNG
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Unicode (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç)

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- [ ] Retry –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ (–º–∏–Ω–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏)
- [ ] Graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SIGTERM/SIGINT
- [ ] Worker pool —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–æ—Ä–∫–µ—Ä–æ–≤
- [ ] Timeout –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (MinIO, ExifTool)
- [ ] Temporary —Ñ–∞–π–ª—ã –æ—á–∏—â–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (coverage > 80%)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ MinIO –∏ RabbitMQ
- [ ] –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ Unicode
- [ ] –¢–µ—Å—Ç—ã error scenarios
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç: `make test`

### Code Quality
- [ ] –ö–æ–¥ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏–Ω—Ç–µ—Ä: `make lint`
- [ ] –°–ª–µ–¥—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Analyzer Service
- [ ] –í—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¥–ª—è DI –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Deployment
- [ ] Dockerfile —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Environment variables –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Docker –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### Documentation
- [ ] README —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–µ—Ä–≤–∏—Å–∞
- [ ] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–ª—é—á–µ–≤—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
- [ ] –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### ExifTool –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [Official ExifTool documentation](https://exiftool.org/)
- [Tag Names](https://exiftool.org/TagNames/index.html)
- [EXIF Tags](https://exiftool.org/TagNames/EXIF.html)
- [IPTC Tags](https://exiftool.org/TagNames/IPTC.html)
- [XMP Tags](https://exiftool.org/TagNames/XMP.html)

### Go –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- [MinIO Go Client](https://github.com/minio/minio-go)
- [AMQP (RabbitMQ) for Go](https://github.com/rabbitmq/amqp091-go)
- [Logrus](https://github.com/sirupsen/logrus)

### –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –∫–æ–¥
- Analyzer Service: `/services/analyzer`
- Gateway Service: `/services/gateway`
- Shared packages: `/pkg`

---

## üéØ –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –î–µ–Ω—å 1-2: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
1. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Config
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ExifTool client + —Ç–µ—Å—Ç—ã
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Dockerfile —Å ExifTool

### –î–µ–Ω—å 3-4: Core –ª–æ–≥–∏–∫–∞
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å MinIO client (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ + –∑–∞–≥—Ä—É–∑–∫–∞)
6. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ImageProcessor service
7. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å MessageProcessor service
8. Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –î–µ–Ω—å 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
9. RabbitMQ Consumer/Publisher
10. App initialization —Å worker pool
11. Docker Compose –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –î–µ–Ω—å 6-7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
12. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
13. E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–ª–Ω—ã–º —Ñ–ª–æ—É
14. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤
15. Code review –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
16. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üöÄ –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

–ö–æ–≥–¥–∞ Processor Service –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤:
1. ‚úÖ **MVP —Å–∏—Å—Ç–µ–º—ã –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!**
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å full E2E —Ç–µ—Å—Ç –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
3. Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ production –¥–µ–ø–ª–æ—é

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ Processor:**
- CI/CD pipeline
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
- Production deployment
