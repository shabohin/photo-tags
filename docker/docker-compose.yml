version: '3.8'

services:
    rabbitmq:
        container_name: rabbitmq
        image: rabbitmq:3-management-alpine
        ports:
            - '5672:5672'
            - '15672:15672'
        environment:
            - RABBITMQ_DEFAULT_USER=user
            - RABBITMQ_DEFAULT_PASS=password
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        healthcheck:
            test: ['CMD', 'rabbitmq-diagnostics', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5

    minio:
        container_name: minio
        image: minio/minio
        ports:
            - '9000:9000'
            - '9001:9001'
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
        volumes:
            - minio_data:/data
        command: server /data --console-address ":9001"
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
            interval: 10s
            timeout: 5s
            retries: 5

    gateway:
        container_name: gateway
        build:
            context: ..
            dockerfile: docker/Dockerfile.service
            args:
                SERVICE: gateway
        ports:
            - '8080:8080'
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        env_file: .env
        environment:
            - RABBITMQ_URL=amqp://user:password@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin

    analyzer:
        container_name: analyzer
        build:
            context: ..
            dockerfile: docker/Dockerfile.service
            args:
                SERVICE: analyzer
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        env_file: .env
        environment:
            - RABBITMQ_URL=amqp://user:password@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin
            - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}

    processor:
        container_name: processor
        build:
            context: ../services/processor
            dockerfile: Dockerfile
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        environment:
            - RABBITMQ_URL=amqp://user:password@rabbitmq:5672/
            - RABBITMQ_CONSUMER_QUEUE=metadata_generated
            - RABBITMQ_PUBLISHER_QUEUE=image_processed
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin
            - MINIO_ORIGINAL_BUCKET=original
            - MINIO_PROCESSED_BUCKET=processed
            - EXIFTOOL_BINARY_PATH=/usr/bin/exiftool
            - EXIFTOOL_TEMP_DIR=/tmp/processor
            - WORKER_CONCURRENCY=3
            - LOG_LEVEL=info
            - LOG_FORMAT=json
        restart: unless-stopped
        volumes:
            - processor_temp:/tmp/processor

    dashboard:
        container_name: dashboard
        build:
            context: ../services/dashboard
            dockerfile: Dockerfile
        ports:
            - '3000:3000'
        depends_on:
            rabbitmq:
                condition: service_healthy
        environment:
            - DASHBOARD_PORT=3000
            - RABBITMQ_URL=amqp://user:password@rabbitmq:5672/
            - GATEWAY_URL=http://gateway:8080
            - ANALYZER_URL=http://analyzer:8081
            - PROCESSOR_URL=http://processor:8082
            - MINIO_URL=http://localhost:9001
            - RABBITMQ_MGMT_URL=http://localhost:15672
        restart: unless-stopped

volumes:
    rabbitmq_data:
    minio_data:
    processor_temp:
